# üöÄ Configura√ß√£o Unificada: A/B + Blue/Green + Canary + Cross-Cluster
# Todas as estrat√©gias aplicadas simultaneamente na mesma aplica√ß√£o

---
# üåê Gateway Principal - Ponto de Entrada √önico
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: ecommerce-unified-gateway
  namespace: ecommerce
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "ecommerce.local"
    - "*"
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: ecommerce-tls
    hosts:
    - "ecommerce.local"

---
# üéØ VirtualService Unificado - Roteamento Inteligente Combinado
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ecommerce-unified-routing
  namespace: ecommerce
spec:
  hosts:
  - "ecommerce.local"
  - "*"
  gateways:
  - ecommerce-unified-gateway
  - mesh # Para comunica√ß√£o interna
  http:
  
  # üß™ CANARY DEPLOYMENT - 5% do tr√°fego para vers√£o canary
  - match:
    - headers:
        canary-user:
          exact: "true"
    - headers:
        x-canary-test:
          exact: "enabled"
    - weight: 5  # 5% de todo o tr√°fego vai para canary
    route:
    - destination:
        host: ecommerce-app
        subset: canary
      weight: 100
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 50ms
    timeout: 10s
    retries:
      attempts: 3
      perTryTimeout: 3s
      retryOn: 5xx,reset,connect-failure,refused-stream
  
  # üîµ A/B TESTING - Baseado em tipo de usu√°rio e geografia
  - match:
    - headers:
        user-type:
          exact: "premium"
        x-ab-test:
          exact: "group-a"
    - headers:
        x-user-segment:
          exact: "beta-testers"
    - headers:
        x-geo-region:
          regex: "us-.*|eu-.*"  # Usu√°rios US e EU
    route:
    - destination:
        host: ecommerce-app
        subset: blue  # Vers√£o Blue para grupo A
      weight: 100
    headers:
      request:
        add:
          x-ab-group: "A"
          x-feature-flags: "new-ui,advanced-search"
  
  - match:
    - headers:
        user-type:
          exact: "premium"
        x-ab-test:
          exact: "group-b"
    - headers:
        x-user-segment:
          exact: "regular-users"
    route:
    - destination:
        host: ecommerce-app
        subset: green  # Vers√£o Green para grupo B
      weight: 100
    headers:
      request:
        add:
          x-ab-group: "B"
          x-feature-flags: "classic-ui,basic-search"
  
  # üü¢ BLUE/GREEN DEPLOYMENT - Baseado em header de deployment
  - match:
    - headers:
        deployment-target:
          exact: "blue"
    - headers:
        x-deployment-strategy:
          exact: "blue-green"
    route:
    - destination:
        host: ecommerce-app
        subset: blue
      weight: 100
    headers:
      request:
        add:
          x-deployment-env: "blue"
          x-cluster-target: "primary"
  
  - match:
    - headers:
        deployment-target:
          exact: "green"
    - headers:
        x-deployment-strategy:
          exact: "blue-green"
    route:
    - destination:
        host: ecommerce-app
        subset: green
      weight: 100
    headers:
      request:
        add:
          x-deployment-env: "green"
          x-cluster-target: "secondary"
  
  # üåä SHADOW TRAFFIC - Tr√°fego espelhado para testes
  - match:
    - headers:
        x-shadow-test:
          exact: "enabled"
    route:
    - destination:
        host: ecommerce-app
        subset: stable
      weight: 100
    mirror:
      host: ecommerce-app
      subset: canary
    mirrorPercentage:
      value: 100
    headers:
      request:
        add:
          x-shadow-traffic: "true"
  
  # üé≤ WEIGHTED ROUTING - Distribui√ß√£o inteligente baseada em m√∫ltiplos fatores
  - match:
    - headers:
        x-user-tier:
          exact: "enterprise"
    route:
    - destination:
        host: ecommerce-app
        subset: blue
      weight: 60  # 60% para Blue (est√°vel)
    - destination:
        host: ecommerce-app
        subset: green
      weight: 35  # 35% para Green (nova vers√£o)
    - destination:
        host: ecommerce-app
        subset: canary
      weight: 5   # 5% para Canary (experimental)
    headers:
      request:
        add:
          x-routing-strategy: "weighted-enterprise"
  
  # üîÑ CROSS-CLUSTER ROUTING - Baseado em disponibilidade e lat√™ncia
  - match:
    - headers:
        x-cross-cluster:
          exact: "enabled"
    - headers:
        x-cluster-preference:
          exact: "secondary"
    route:
    - destination:
        host: ecommerce-app.ecommerce.svc.cluster.local
        subset: stable
      weight: 70
    - destination:
        host: ecommerce-app.ecommerce.global  # Cross-cluster endpoint
        subset: stable
      weight: 30
    headers:
      request:
        add:
          x-cross-cluster-routing: "active"
          x-source-cluster: "primary"
  
  # üì± DEVICE-BASED ROUTING - Baseado no tipo de dispositivo
  - match:
    - headers:
        user-agent:
          regex: ".*Mobile.*|.*Android.*|.*iPhone.*"
    route:
    - destination:
        host: ecommerce-app
        subset: mobile-optimized
      weight: 100
    headers:
      request:
        add:
          x-device-type: "mobile"
          x-ui-variant: "mobile-first"
  
  # üïê TIME-BASED ROUTING - Baseado no hor√°rio (para testes graduais)
  - match:
    - headers:
        x-time-based-routing:
          exact: "enabled"
    route:
    - destination:
        host: ecommerce-app
        subset: blue
      weight: 80
    - destination:
        host: ecommerce-app
        subset: green
      weight: 20
    headers:
      request:
        add:
          x-time-slot: "business-hours"
  
  # üéØ DEFAULT ROUTING - Fallback para tr√°fego n√£o classificado
  - route:
    - destination:
        host: ecommerce-app
        subset: stable
      weight: 90
    - destination:
        host: ecommerce-app
        subset: canary
      weight: 10
    timeout: 15s
    retries:
      attempts: 3
      perTryTimeout: 5s
      retryOn: 5xx,reset,connect-failure,refused-stream
    headers:
      request:
        add:
          x-routing-strategy: "default"
          x-fallback-route: "true"

---
# üéØ DestinationRule Unificado - Defini√ß√£o de Subsets e Pol√≠ticas
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ecommerce-unified-destination
  namespace: ecommerce
spec:
  host: ecommerce-app
  trafficPolicy:
    # üîÑ Load Balancer Configuration
    loadBalancer:
      simple: LEAST_CONN
      consistentHash:
        httpHeaderName: "x-user-id"
    
    # üõ°Ô∏è Connection Pool Settings
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 30s
        keepAlive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 10
        maxRetries: 3
        idleTimeout: 60s
        h2UpgradePolicy: UPGRADE
    
    # üö® Circuit Breaker Configuration
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
    
    # üîí TLS Configuration
    tls:
      mode: ISTIO_MUTUAL
      sni: ecommerce-app.ecommerce.svc.cluster.local
  
  # üìä Subsets - Diferentes vers√µes da aplica√ß√£o
  subsets:
  
  # üîµ Blue Environment (Stable Production)
  - name: blue
    labels:
      version: v1.0.0
      environment: blue
      deployment-strategy: blue-green
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 150
        http:
          maxRequestsPerConnection: 20
      outlierDetection:
        consecutive5xxErrors: 3
        interval: 20s
  
  # üü¢ Green Environment (New Version)
  - name: green
    labels:
      version: v2.0.0
      environment: green
      deployment-strategy: blue-green
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          maxRequestsPerConnection: 15
      outlierDetection:
        consecutive5xxErrors: 2
        interval: 15s
        baseEjectionTime: 60s
  
  # üß™ Canary Environment (Experimental)
  - name: canary
    labels:
      version: v2.1.0-canary
      environment: canary
      deployment-strategy: canary
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 50
        http:
          maxRequestsPerConnection: 5
      outlierDetection:
        consecutive5xxErrors: 1
        interval: 10s
        baseEjectionTime: 120s
  
  # üè† Stable Environment (Current Production)
  - name: stable
    labels:
      version: v1.5.0
      environment: stable
      deployment-strategy: rolling
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 200
        http:
          maxRequestsPerConnection: 25
  
  # üì± Mobile Optimized
  - name: mobile-optimized
    labels:
      version: v1.5.0-mobile
      environment: stable
      optimization: mobile
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 80
        http:
          maxRequestsPerConnection: 12

---
# üåê ServiceEntry para Cross-Cluster Communication
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: ecommerce-cross-cluster
  namespace: ecommerce
spec:
  hosts:
  - ecommerce-app.ecommerce.global
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: http
    protocol: HTTP
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS
  addresses:
  - 10.10.2.100  # IP do cluster secund√°rio
  endpoints:
  - address: ecommerce-app.ecommerce.svc.cluster.local
    network: secondary-cluster
    locality: westus3/secondary
    ports:
      http: 80
      https: 443

---
# üîí PeerAuthentication - mTLS STRICT para toda comunica√ß√£o
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: ecommerce-unified-mtls
  namespace: ecommerce
spec:
  selector:
    matchLabels:
      app: ecommerce-app
  mtls:
    mode: STRICT

---
# üõ°Ô∏è AuthorizationPolicy - Controle de acesso granular
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: ecommerce-unified-authz
  namespace: ecommerce
spec:
  selector:
    matchLabels:
      app: ecommerce-app
  rules:
  
  # ‚úÖ Permitir tr√°fego do Gateway
  - from:
    - source:
        principals: ["cluster.local/ns/aks-istio-system/sa/istio-ingressgateway-service-account"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
  
  # ‚úÖ Permitir tr√°fego cross-cluster
  - from:
    - source:
        namespaces: ["ecommerce"]
    - source:
        principals: ["cluster.local/ns/ecommerce/sa/ecommerce-app"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
    when:
    - key: source.cluster
      values: ["primary", "secondary"]
  
  # ‚úÖ Permitir tr√°fego de monitoramento
  - from:
    - source:
        principals: ["cluster.local/ns/aks-istio-system/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/metrics", "/health", "/ready"]
  
  # ‚úÖ Permitir tr√°fego baseado em headers espec√≠ficos
  - from:
    - source:
        namespaces: ["ecommerce"]
    to:
    - operation:
        methods: ["GET", "POST"]
    when:
    - key: request.headers[x-deployment-strategy]
      values: ["blue-green", "canary", "a-b-test"]

---
# üìä Telemetry Configuration - M√©tricas customizadas
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: ecommerce-unified-metrics
  namespace: ecommerce
spec:
  selector:
    matchLabels:
      app: ecommerce-app
  metrics:
  
  # üìà M√©tricas de Deployment Strategy
  - providers:
    - name: prometheus
  - overrides:
    - match:
        metric: ALL_METRICS
      tagOverrides:
        deployment_strategy:
          value: "%{REQUEST_HEADERS['x-deployment-strategy'] | 'unknown'}"
        ab_test_group:
          value: "%{REQUEST_HEADERS['x-ab-group'] | 'none'}"
        canary_version:
          value: "%{REQUEST_HEADERS['x-canary-version'] | 'stable'}"
        cross_cluster:
          value: "%{REQUEST_HEADERS['x-cross-cluster'] | 'false'}"
        user_segment:
          value: "%{REQUEST_HEADERS['x-user-segment'] | 'default'}"
        device_type:
          value: "%{REQUEST_HEADERS['x-device-type'] | 'desktop'}"
        cluster_source:
          value: "%{REQUEST_HEADERS['x-source-cluster'] | 'unknown'}"
        cluster_target:
          value: "%{REQUEST_HEADERS['x-target-cluster'] | 'unknown'}"
  
  # üéØ Custom Business Metrics
  - providers:
    - name: prometheus
  - overrides:
    - match:
        metric: requests_total
      tagOverrides:
        business_metric:
          value: "deployment_strategy_requests"
    - match:
        metric: request_duration_milliseconds
      tagOverrides:
        business_metric:
          value: "deployment_strategy_latency"

---
# üö® EnvoyFilter - Rate Limiting Avan√ßado
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ecommerce-unified-ratelimit
  namespace: ecommerce
spec:
  workloadSelector:
    labels:
      app: ecommerce-app
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: ecommerce_unified_rate_limiter
            token_bucket:
              max_tokens: 1000
              tokens_per_fill: 100
              fill_interval: 60s
            filter_enabled:
              runtime_key: ecommerce_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: ecommerce_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              header:
                key: x-local-rate-limit
                value: 'true'
            descriptors:
            - entries:
              - key: deployment_strategy
                value: "%{REQUEST_HEADERS['x-deployment-strategy']:='default'}"
              - key: user_type
                value: "%{REQUEST_HEADERS['user-type']:='anonymous'}"
              token_bucket:
                max_tokens: 500
                tokens_per_fill: 50
                fill_interval: 60s
