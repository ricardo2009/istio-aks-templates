apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: 'payment-service-advanced-dr'
  namespace: 'ecommerce-demo'
  labels:
    app: 'payment-service'
    version: 'v1'
  annotations:
    istio.io/description: "Advanced resilience configuration for payment-service"
spec:
  host: 'payment-service.ecommerce-demo.svc.cluster.local'
  trafficPolicy:
    # Load Balancing Strategy
    loadBalancer:
      simple: 'ROUND_ROBIN'
    
    # Connection Pool Settings
    connectionPool:
      tcp:
        maxConnections: 30
        connectTimeout: '10s'
        tcpNoDelay: true
        keepAlive:
          time: '7200s'
          interval: '75s'
          probes: 9
      http:
        http1MaxPendingRequests: 1024
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
        maxRetries: 3
        idleTimeout: '60s'
        h2UpgradePolicy: 'UPGRADE'
        useClientProtocol: true
    
    # Circuit Breaker / Outlier Detection
    outlierDetection:
      consecutive5xxErrors: 3
      consecutiveGatewayErrors: 5
      interval: '10s'
      baseEjectionTime: '60s'
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
    
    # Port-specific policies
    portLevelSettings:
    - port:
        number: 80
      connectionPool:
        tcp:
          maxConnections: 50
        http:
          http1MaxPendingRequests: 512
          maxRequestsPerConnection: 5
      outlierDetection:
        consecutive5xxErrors: 3
  
  # Subsets for different versions
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 80
        http:
          maxRequestsPerConnection: 8
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 120
        http:
          maxRequestsPerConnection: 12
  - name: canary
    labels:
      version: canary
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 20
        http:
          maxRequestsPerConnection: 2
      outlierDetection:
        consecutive5xxErrors: 2
        interval: '5s'
        baseEjectionTime: '15s'
